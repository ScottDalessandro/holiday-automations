---
import Analytics from '@vercel/analytics/astro';
import Background from '../components/Background.astro';
import LessonNav from '../components/LessonNav.astro';
import LessonHero from '../components/LessonHero.astro';
import LessonVideo from '../components/LessonVideo.astro';
import WorkflowDiagram from '../components/WorkflowDiagram.astro';
import StepList from '../components/StepList.astro';
import CodeBlock from '../components/CodeBlock.astro';
import KeyConcepts from '../components/KeyConcepts.astro';
import SidebarCard from '../components/SidebarCard.astro';
import BonusCard from '../components/BonusCard.astro';
import LessonCTA from '../components/LessonCTA.astro';
import Footer from '../components/Footer.astro';

interface Props {
  title: string;
  description?: string;
  icon?: string;
  tutorialNumber?: number;
  videoUrl?: string;
  workflowDescription?: string;
  workflowNodes?: { icon: string; label: string; color?: 'emerald' | 'rose' | 'slate' | 'amber' | 'sky' | 'violet' }[];
  steps?: { title: string; content: string }[];
  codeBlocks?: { label: string; code: string }[];
  concepts?: { icon: string; title: string; description: string }[];
  resources?: { icon: string; label: string; url: string }[];
  skills?: string[];
  bonusIdeas?: { title: string; description: string }[];
  nextLesson?: { title: string; slug: string };
  workflowJson?: string;
  slug?: string;
}

const {
  title,
  description,
  icon = '&#9889;',
  tutorialNumber = 1,
  videoUrl,
  workflowDescription,
  workflowNodes,
  steps,
  codeBlocks,
  concepts,
  resources,
  skills,
  bonusIdeas,
  nextLesson,
  workflowJson,
  slug
} = Astro.props;
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description || 'n8n tutorial lesson'} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <title>{title} | Holiday Automations</title>
  </head>
  <body class="bg-slate-950 text-slate-300 antialiased overflow-x-hidden relative selection:bg-rose-500/30 selection:text-rose-200">

    <Background />
    <LessonNav />

    <main class="relative z-10 pt-32 pb-20">
      <LessonHero
        tutorialNumber={tutorialNumber}
        icon={icon}
        title={title}
        description={description}
      />

      {videoUrl && <LessonVideo videoUrl={videoUrl} />}

      <!-- Main Content Grid -->
      <div class="w-full max-w-6xl mx-auto px-6 grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">

        <!-- Left Column (Content) -->
        <div class="lg:col-span-2 space-y-8">
          {workflowNodes && workflowNodes.length > 0 && (
            <WorkflowDiagram nodes={workflowNodes} description={workflowDescription} />
          )}

          {steps && steps.length > 0 && (
            <StepList steps={steps} />
          )}

          {codeBlocks && codeBlocks.length > 0 && (
            <CodeBlock codeBlocks={codeBlocks} />
          )}

          {concepts && concepts.length > 0 && (
            <KeyConcepts concepts={concepts} />
          )}

          <!-- Slot for any additional content from markdown -->
          <slot />
        </div>

        <!-- Right Sidebar -->
        <aside class="space-y-8 lg:sticky lg:top-24">
          {workflowJson && (
            <SidebarCard variant="workflow" workflowJson={workflowJson} workflowSlug={slug} />
          )}

          {resources && resources.length > 0 && (
            <SidebarCard variant="resources" resources={resources} />
          )}

          {skills && skills.length > 0 && (
            <SidebarCard variant="skills" skills={skills} />
          )}

          {bonusIdeas && bonusIdeas.length > 0 && (
            <BonusCard ideas={bonusIdeas} />
          )}
        </aside>
      </div>

      <LessonCTA nextLesson={nextLesson} />

    </main>

    <Footer compact />
    <Analytics />
  </body>
</html>

<style is:global>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

body {
  font-family: 'Inter', sans-serif;
  background-color: #020617;
  cursor: default;
}

.font-mono {
  font-family: 'JetBrains Mono', monospace;
}

/* --- Animations --- */
@keyframes twinkle {
  0%, 100% { opacity: 0.3; transform: scale(0.8); }
  50% { opacity: 1; transform: scale(1.2); }
}

@keyframes light-turn-on {
  0% { opacity: 0; transform: scale(0); }
  60% { opacity: 1; transform: scale(1.2); }
  100% { opacity: 1; transform: scale(1); }
}

@keyframes bulb-bounce {
  0% { transform: translateY(0) scale(1); }
  40% { transform: translateY(-8px) scale(1.1); }
  100% { transform: translateY(0) scale(1); }
}

@keyframes wire-sway {
  0%, 100% { transform: rotate(0deg); }
  25% { transform: rotate(0.5deg); }
  75% { transform: rotate(-0.5deg); }
}

@keyframes dash-flow {
  to { stroke-dashoffset: -24; }
}

/* --- Components --- */
.bulb-interactive {
  position: relative;
  cursor: pointer;
  transition: transform 0.3s ease;
}
.bulb-interactive:hover .bulb-glass {
  animation: bulb-bounce 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  filter: brightness(1.3) drop-shadow(0 0 15px currentColor);
}
.bulb-interactive:hover .bulb-tooltip {
  opacity: 1;
  transform: translate(-50%, 14px);
}
.lights-wrapper.swaying {
  animation: wire-sway 1s ease-in-out infinite;
  transform-origin: top center;
}

.flow-line {
  stroke-dasharray: 6 6;
  animation: dash-flow 1s linear infinite;
}

.fade-up {
  opacity: 0;
  transform: translateY(30px);
  transition: opacity 0.8s ease-out, transform 0.8s ease-out;
}
.fade-up.visible {
  opacity: 1;
  transform: translateY(0);
}

.bg-grid {
  background-size: 50px 50px;
  background-image: linear-gradient(to right, rgba(255, 255, 255, 0.03) 1px, transparent 1px),
  linear-gradient(to bottom, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
}

::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: #020617; }
::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
</style>
