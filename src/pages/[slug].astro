---
import LessonLayout from '../layouts/LessonLayout.astro';
import { getCollection } from 'astro:content';
import fs from 'node:fs';
import path from 'node:path';

export async function getStaticPaths() {
  const lessons = await getCollection('lessons');
  return lessons.map((lesson) => ({
    params: { slug: lesson.slug },
    props: { lesson },
  }));
}

const { lesson } = Astro.props;
const { Content } = await lesson.render();
const data = lesson.data;

// Support both videoId (YouTube ID) and videoUrl (full URL)
const videoUrl = data.videoUrl || (data.videoId ? `https://youtu.be/${data.videoId}` : undefined);

// Load workflow JSON from file if workflowFile is specified
let workflowJson = data.workflowJson;
if (data.workflowFile) {
  try {
    const workflowPath = path.join(process.cwd(), 'public', data.workflowFile);
    workflowJson = fs.readFileSync(workflowPath, 'utf-8');
  } catch (e) {
    console.warn(`Could not load workflow file: ${data.workflowFile}`);
  }
}
---

<LessonLayout
  title={data.title}
  description={data.description}
  icon={data.icon}
  tutorialNumber={data.tutorialNumber}
  videoUrl={videoUrl}
  workflowDescription={data.workflowDescription}
  workflowNodes={data.workflowNodes}
  steps={data.steps}
  codeBlocks={data.codeBlocks}
  concepts={data.concepts}
  resources={data.resources}
  skills={data.skills}
  bonusIdeas={data.bonusIdeas}
  nextLesson={data.nextLesson}
  workflowJson={workflowJson}
  slug={lesson.slug}
>
  <Content />
</LessonLayout>
